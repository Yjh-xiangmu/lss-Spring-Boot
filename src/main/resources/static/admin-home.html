<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿç®¡ç†ä¸­å°</title>
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --glass: rgba(255, 255, 255, 0.85);
            --glass-dark: rgba(15, 23, 42, 0.85);
            --text-main: #1e293b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            height: 100vh; overflow: hidden; display: flex;
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 260px; background: var(--glass-dark); backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255,255,255,0.1); padding: 25px;
            display: flex; flex-direction: column; color: white; z-index: 10;
        }
        .brand { font-size: 22px; font-weight: 800; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .brand i { color: #FF6B6B; }

        .menu-item {
            padding: 14px 20px; margin-bottom: 5px; border-radius: 12px; cursor: pointer;
            color: #94a3b8; font-weight: 500; display: flex; align-items: center; gap: 15px;
            transition: 0.3s;
        }
        .menu-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .menu-item.active { background: var(--primary); color: white; box-shadow: 0 5px 15px rgba(99, 102, 241, 0.4); }

        /* ä¸»å†…å®¹ */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; position: relative; }

        /* é¡¶éƒ¨æ  */
        .header {
            background: var(--glass); backdrop-filter: blur(12px);
            border-radius: 20px; padding: 15px 30px; margin-bottom: 30px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }
        .admin-profile { display: flex; align-items: center; gap: 15px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: #e0e7ff; display: flex; align-items: center; justify-content: center; color: var(--primary); }

        /* é€šç”¨é¢æ¿ */
        .panel {
            background: var(--glass); backdrop-filter: blur(12px);
            border-radius: 24px; padding: 30px; margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .panel-title { font-size: 20px; font-weight: 700; color: var(--text-main); border-left: 5px solid var(--primary); padding-left: 15px; }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 25px; margin-bottom: 30px; }
        .stat-card {
            background: rgba(255,255,255,0.9); border-radius: 20px; padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 20px;
            transition: 0.3s; cursor: pointer;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-icon { width: 60px; height: 60px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 28px; color: white; }

        /* è¡¨æ ¼æ ·å¼ */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; color: #64748b; font-size: 13px; border-bottom: 2px solid #f1f5f9; }
        td { padding: 15px; color: #334155; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        .tag { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .tag-green { background: #dcfce7; color: #166534; }
        .tag-red { background: #fee2e2; color: #991b1b; }
        .tag-blue { background: #dbeafe; color: #1e40af; }
        .tag-purple { background: #f3e8ff; color: #7e22ce; }

        /* æŒ‰é’® */
        .btn { padding: 8px 16px; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; font-size: 13px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #4f46e5; }
        .btn-danger { background: #fee2e2; color: #ef4444; }
        .btn-danger:hover { background: #fecaca; }
        .btn-icon { width: 32px; height: 32px; border-radius: 8px; display: inline-flex; align-items: center; justify-content: center; margin-right: 5px; }

        .section-view { display: none; }
        .section-view.active { display: block; }

        /* å¼¹çª— */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal.active { display: flex; }
        .modal-box { background: white; border-radius: 20px; width: 600px; padding: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: #334155; }
        .form-control { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; outline: none; transition: 0.3s; }
        .form-control:focus { border-color: var(--primary); }
        .preview-img { width: 100px; height: 100px; border-radius: 10px; object-fit: cover; margin-top: 10px; background: #f1f5f9; display: none; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="brand"><i class="fas fa-shield-alt"></i> ç®¡ç†ä¸­å°</div>
    <div class="menu">
        <div class="menu-item active" onclick="switchTab('data-stats')"><i class="fas fa-chart-line"></i> æ•°æ®æ¦‚è§ˆ</div>
        <div class="menu-item" onclick="switchTab('volunteer-mgr')"><i class="fas fa-users"></i> å¿—æ„¿è€…ç®¡ç†</div>
        <div class="menu-item" onclick="switchTab('organizer-mgr')"><i class="fas fa-building"></i> ç»„ç»‡è€…ç®¡ç†</div>
        <div class="menu-item" onclick="switchTab('type-mgr')"><i class="fas fa-tags"></i> æ´»åŠ¨åˆ†ç±»ç®¡ç†</div>
        <div class="menu-item" onclick="switchTab('mall-mgr')"><i class="fas fa-gift"></i> å•†åŸè®¢å•</div>
        <div class="menu-item" onclick="switchTab('news-mgr')"><i class="fas fa-newspaper"></i> èµ„è®¯å‘å¸ƒ</div>
    </div>
</div>

<div class="main-content">
    <div class="header">
        <div>
            <h2 style="font-size:18px; font-weight:700;">æ¬¢è¿å›æ¥ï¼Œç®¡ç†å‘˜</h2>
            <p style="font-size:13px; color:#64748b; margin-top:5px;">ä»Šå¤©æ˜¯ <span id="currentDate"></span></p>
        </div>
        <div class="admin-profile">
            <div class="avatar"><i class="fas fa-user-shield"></i></div>
            <button class="btn btn-danger" onclick="logout()">é€€å‡º</button>
        </div>
    </div>

    <div id="data-stats" class="section-view active">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon" style="background:linear-gradient(135deg,#6366f1,#8b5cf6)"><i class="fas fa-users"></i></div>
                <div><h3 id="totalUsers">0</h3><p style="color:#94a3b8; font-size:13px;">æ€»ç”¨æˆ·æ•°</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background:linear-gradient(135deg,#10b981,#34d399)"><i class="fas fa-flag"></i></div>
                <div><h3 id="totalActivities">0</h3><p style="color:#94a3b8; font-size:13px;">æ´»åŠ¨å‘å¸ƒ</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background:linear-gradient(135deg,#f59e0b,#fbbf24)"><i class="fas fa-clipboard-check"></i></div>
                <div><h3 id="totalRecords">0</h3><p style="color:#94a3b8; font-size:13px;">æœåŠ¡è®°å½•</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background:linear-gradient(135deg,#ec4899,#f472b6)"><i class="fas fa-shopping-bag"></i></div>
                <div><h3>Running</h3><p style="color:#94a3b8; font-size:13px;">ç³»ç»ŸçŠ¶æ€</p></div>
            </div>
        </div>
    </div>

    <div id="volunteer-mgr" class="section-view">
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">å¿—æ„¿è€…åå½•</div>
                <button class="btn btn-primary" onclick="loadUsers(1, 1)"><i class="fas fa-sync"></i> åˆ·æ–°</button>
            </div>
            <table>
                <thead><tr><th>ID</th><th>å§“å</th><th>æ‰‹æœº</th><th>ç¤¾åŒº</th><th>ç§¯åˆ†</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="tbody-vol"></tbody>
            </table>
        </div>
    </div>

    <div id="organizer-mgr" class="section-view">
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">ç»„ç»‡è€…å®¡æ ¸</div>
            </div>
            <table>
                <thead><tr><th>ID</th><th>ç»„ç»‡åç§°</th><th>è”ç³»æ–¹å¼</th><th>åœ°å€</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="tbody-org"></tbody>
            </table>
        </div>
    </div>

    <div id="type-mgr" class="section-view">
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">æ´»åŠ¨åˆ†ç±»å­—å…¸</div>
                <button class="btn btn-primary" onclick="openTypeModal()"><i class="fas fa-plus"></i> æ–°å¢åˆ†ç±»</button>
            </div>
            <table>
                <thead><tr><th>ID</th><th>åˆ†ç±»åç§°</th><th>æ’åºæƒé‡</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="tbody-type"></tbody>
            </table>
        </div>
    </div>

    <div id="mall-mgr" class="section-view">
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">å•†åŸè¿è¥</div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-primary" onclick="toggleMallView('product')">å•†å“åº“</button>
                    <button class="btn btn-primary" style="background:#8b5cf6" onclick="toggleMallView('order')">è®¢å•å¤„ç†</button>
                </div>
            </div>

            <div id="mall-products">
                <button class="btn btn-primary" style="margin-bottom:15px;" onclick="openProductModal()">+ ä¸Šæ¶å•†å“</button>
                <table><thead><tr><th>å›¾</th><th>åç§°</th><th>ç§¯åˆ†</th><th>åº“å­˜</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead><tbody id="tbody-product"></tbody></table>
            </div>

            <div id="mall-orders" style="display:none;">
                <table><thead><tr><th>å•å·</th><th>å•†å“</th><th>ç”¨æˆ·</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead><tbody id="tbody-order"></tbody></table>
            </div>
        </div>
    </div>

    <div id="news-mgr" class="section-view">
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">å†…å®¹å‘å¸ƒ</div>
                <button class="btn btn-primary" onclick="openArticleModal()">+ å‘å¸ƒèµ„è®¯</button>
            </div>
            <table>
                <thead><tr><th>å°é¢</th><th>æ ‡é¢˜</th><th>ç±»å‹</th><th>ç½®é¡¶</th><th>æµè§ˆ</th><th>å‘å¸ƒæ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="tbody-news"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal" id="typeModal">
    <div class="modal-box" style="width: 400px;">
        <h3 style="margin-bottom:20px; font-size:20px;">ğŸ·ï¸ æ´»åŠ¨åˆ†ç±»ç¼–è¾‘</h3>
        <form id="typeForm">
            <input type="hidden" id="typeId">
            <div class="form-group">
                <label class="form-label">åˆ†ç±»åç§° <span style="color:red">*</span></label>
                <input type="text" class="form-control" id="typeName" required placeholder="å¦‚ï¼šç¯å¢ƒä¿æŠ¤">
            </div>
            <div class="form-group" style="display:flex; gap:15px;">
                <div style="flex:1;">
                    <label class="form-label">æ’åºæƒé‡</label>
                    <input type="number" class="form-control" id="typeSort" value="0" required>
                    <p style="font-size:12px; color:#999; margin-top:5px;">æ•°å­—è¶Šå°æ’è¶Šå‰</p>
                </div>
                <div style="flex:1;">
                    <label class="form-label">çŠ¶æ€</label>
                    <select class="form-control" id="typeStatus">
                        <option value="1">å¯ç”¨ (å¯è§)</option>
                        <option value="0">ç¦ç”¨ (éšè—)</option>
                    </select>
                </div>
            </div>
            <div style="text-align:right; display:flex; gap:10px; justify-content:flex-end;">
                <button type="button" class="btn" onclick="closeModal('typeModal')">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">ä¿å­˜</button>
            </div>
        </form>
    </div>
</div>

<div class="modal" id="articleModal">
    <div class="modal-box">
        <h3 style="margin-bottom:20px; font-size:20px;">ğŸ“ èµ„è®¯ç¼–è¾‘</h3>
        <form id="articleForm">
            <input type="hidden" id="artId">
            <div class="form-group"><label class="form-label">æ ‡é¢˜</label><input type="text" class="form-control" id="artTitle" required></div>
            <div class="form-group" style="display:flex; gap:15px;">
                <div style="flex:1;"><label class="form-label">ç±»å‹</label><select class="form-control" id="artType"><option value="1">é€šçŸ¥å…¬å‘Š</option><option value="2">æ´»åŠ¨é£é‡‡</option><option value="3">å¿—æ„¿è€…æ•…äº‹</option></select></div>
                <div style="flex:1;"><label class="form-label">ç½®é¡¶</label><select class="form-control" id="artTop"><option value="0">å¦</option><option value="1">æ˜¯</option></select></div>
            </div>
            <div class="form-group">
                <label class="form-label">å°é¢å›¾</label><input type="file" id="artFile" accept="image/*" onchange="handleArtImg(this)"><img id="artPreview" class="preview-img"><input type="hidden" id="artBase64">
                <p style="font-size:12px; color:#999; margin-top:5px;">å»ºè®®å›¾ç‰‡å°äº 1MB</p>
            </div>
            <div class="form-group"><label class="form-label">æ­£æ–‡å†…å®¹</label><textarea class="form-control" id="artContent" rows="5" required></textarea></div>
            <div style="text-align:right; display:flex; gap:10px; justify-content:flex-end;"><button type="button" class="btn" onclick="closeModal('articleModal')">å–æ¶ˆ</button><button type="submit" class="btn btn-primary">å‘å¸ƒ</button></div>
        </form>
    </div>
</div>

<div class="modal" id="productModal">
    <div class="modal-box">
        <h3 style="margin-bottom:20px;">ğŸ å•†å“ç¼–è¾‘</h3>
        <form id="productForm">
            <input type="hidden" id="prodId">
            <div class="form-group"><label class="form-label">åç§°</label><input type="text" class="form-control" id="prodName" required></div>
            <div class="form-group" style="display:flex; gap:15px;">
                <div style="flex:1;"><label class="form-label">ç§¯åˆ†</label><input type="number" class="form-control" id="prodPrice" required></div>
                <div style="flex:1;"><label class="form-label">åº“å­˜</label><input type="number" class="form-control" id="prodStock" required></div>
            </div>
            <div class="form-group"><label class="form-label">å›¾ç‰‡</label><input type="file" accept="image/*" onchange="handleProdImg(this)"><img id="prodPreview" class="preview-img"><input type="hidden" id="prodBase64"></div>
            <div style="text-align:right;"><button type="button" class="btn" onclick="closeModal('productModal')">å–æ¶ˆ</button><button type="submit" class="btn btn-primary">ä¿å­˜</button></div>
        </form>
    </div>
</div>

<script>
    window.onload = function() {
        document.getElementById('currentDate').innerText = new Date().toLocaleDateString();
        loadStats();
        loadUsers(1,1);
    };

    // åˆ‡æ¢é¢æ¿
    function switchTab(id) {
        document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
        document.querySelectorAll('.section-view').forEach(v => v.classList.remove('active'));
        event.currentTarget.classList.add('active');
        document.getElementById(id).classList.add('active');

        if(id==='volunteer-mgr') loadUsers(1,1);
        if(id==='organizer-mgr') loadUsers(1,2);
        if(id==='type-mgr') loadTypes(); // åŠ è½½åˆ†ç±»
        if(id==='mall-mgr') { loadProducts(); loadOrders(); }
        if(id==='news-mgr') loadNews();
    }

    // ==========================================
    // æ–°å¢ï¼šæ´»åŠ¨åˆ†ç±»ç®¡ç†é€»è¾‘
    // ==========================================
    async function loadTypes() {
        try {
            // è°ƒç”¨ä¹‹å‰åœ¨ ActivityTypeController å†™çš„ /all æ¥å£
            const res = await fetch('http://localhost:8080/api/activity-type/all');
            const d = await res.json();
            if(d.code === 200) {
                document.getElementById('tbody-type').innerHTML = d.data.map(t => `
                    <tr>
                        <td>#${t.id}</td>
                        <td><span class="tag tag-purple">${t.typeName}</span></td>
                        <td>${t.sort}</td>
                        <td><span class="tag ${t.status === 1 ? 'tag-green' : 'tag-red'}">${t.status === 1 ? 'å¯ç”¨' : 'ç¦ç”¨'}</span></td>
                        <td>
                            <button class="btn btn-primary" style="padding: 5px 10px;" onclick="editType(${t.id}, '${t.typeName}', ${t.sort}, ${t.status})">ç¼–è¾‘</button>
                            <button class="btn btn-danger" style="padding: 5px 10px;" onclick="delType(${t.id})">åˆ é™¤</button>
                        </td>
                    </tr>`).join('');
            }
        } catch (e) {
            console.error('åŠ è½½åˆ†ç±»å¤±è´¥', e);
        }
    }

    function openTypeModal() {
        document.getElementById('typeForm').reset();
        document.getElementById('typeId').value = '';
        document.getElementById('typeModal').classList.add('active');
    }

    function editType(id, name, sort, status) {
        document.getElementById('typeId').value = id;
        document.getElementById('typeName').value = name;
        document.getElementById('typeSort').value = sort;
        document.getElementById('typeStatus').value = status;
        document.getElementById('typeModal').classList.add('active');
    }

    document.getElementById('typeForm').addEventListener('submit', async e => {
        e.preventDefault();
        const data = {
            id: document.getElementById('typeId').value || null,
            typeName: document.getElementById('typeName').value,
            sort: document.getElementById('typeSort').value,
            status: document.getElementById('typeStatus').value
        };
        const url = data.id ? 'http://localhost:8080/api/activity-type/update' : 'http://localhost:8080/api/activity-type/add';
        const method = data.id ? 'PUT' : 'POST';

        try {
            const res = await fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if (result.code === 200) {
                closeModal('typeModal');
                loadTypes();
            } else {
                alert('ä¿å­˜å¤±è´¥: ' + result.msg);
            }
        } catch (err) { alert('ç½‘ç»œé”™è¯¯'); }
    });

    async function delType(id) {
        if(confirm('ç¡®å®šåˆ é™¤è¯¥åˆ†ç±»å—ï¼Ÿ\næ³¨æ„ï¼šå¦‚æœå·²æœ‰ç»„ç»‡è€…ä½¿ç”¨äº†è¯¥åˆ†ç±»å‘æ´»åŠ¨ï¼Œå»ºè®®ç‚¹â€œç¼–è¾‘â€å°†å…¶çŠ¶æ€æ”¹ä¸ºã€ç¦ç”¨ã€‘ï¼Œè€Œä¸æ˜¯ç›´æ¥åˆ é™¤ï¼')) {
            try {
                const res = await fetch(`http://localhost:8080/api/activity-type/${id}`, {method: 'DELETE'});
                const result = await res.json();
                if(result.code === 200) loadTypes();
                else alert(result.msg || 'åˆ é™¤å¤±è´¥');
            } catch (e) { alert('ç½‘ç»œå¼‚å¸¸'); }
        }
    }
    // ==========================================


    // å…¶ä»–åŸæœ‰é€»è¾‘ (Stats, Users, News, Mall)
    async function loadStats() {
        try {
            const res = await fetch('http://localhost:8080/api/admin/stats');
            const d = await res.json();
            if(d.code===200) {
                document.getElementById('totalUsers').innerText = d.data.userCount;
                document.getElementById('totalActivities').innerText = d.data.activityCount;
                document.getElementById('totalRecords').innerText = d.data.totalRecords;
            }
        } catch(e){}
    }

    async function loadUsers(p, type) {
        const tbody = type===1 ? document.getElementById('tbody-vol') : document.getElementById('tbody-org');
        const res = await fetch(`http://localhost:8080/api/admin/users?pageNum=${p}&type=${type}`);
        const d = await res.json();
        if(d.code===200) {
            tbody.innerHTML = d.data.records.map(u => `
                <tr>
                    <td>#${u.id}</td><td>${u.realName||u.username}</td><td>${u.phone||'-'}</td><td>${u.community||u.address||'-'}</td>
                    ${type===1?`<td>${u.points||0}</td>`:''}
                    <td><span class="tag ${u.status===1?'tag-green':'tag-red'}">${u.status===1?'æ­£å¸¸':'å°ç¦'}</span></td>
                    <td><button class="btn btn-icon ${u.status===1?'btn-danger':'btn-primary'}" onclick="changeUserStatus(${u.id},${u.status===1?0:1},${type})"><i class="fas ${u.status===1?'fa-ban':'fa-check'}"></i></button></td>
                </tr>`).join('');
        }
    }
    async function changeUserStatus(id, s, type) {
        await fetch('http://localhost:8080/api/admin/user/status', { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id,status:s})});
        loadUsers(1, type);
    }

    async function loadNews() {
        const res = await fetch('http://localhost:8080/api/article/list');
        const d = await res.json();
        if(d.code===200) {
            document.getElementById('tbody-news').innerHTML = d.data.records.map(a => `
                <tr>
                    <td><img src="${a.coverImage||''}" style="width:50px;height:30px;object-fit:cover;border-radius:4px;"></td>
                    <td style="max-width:200px;">${a.title}</td>
                    <td><span class="tag tag-blue">${{1:'å…¬å‘Š',2:'é£é‡‡',3:'æ•…äº‹'}[a.articleType]}</span></td>
                    <td>${a.isTop?'<i class="fas fa-thumbtack" style="color:#f59e0b"></i>':'-'}</td>
                    <td>${a.views}</td>
                    <td style="font-size:12px;color:#64748b">${a.createTime ? a.createTime.split('T')[0] : '-'}</td>
                    <td><button class="btn btn-danger" onclick="delArticle(${a.id})">åˆ </button></td>
                </tr>`).join('');
        }
    }

    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function openArticleModal() { document.getElementById('articleModal').classList.add('active'); }

    function handleArtImg(input) {
        if(input.files[0]) {
            if (input.files[0].size > 1024 * 1024 * 2) {
                alert('å›¾ç‰‡å¤ªå¤§ï¼Œè¯·é€‰æ‹©å°äº 2MB çš„å›¾ç‰‡');
                return;
            }
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('artBase64').value = e.target.result;
                document.getElementById('artPreview').src = e.target.result;
                document.getElementById('artPreview').style.display='block';
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    document.getElementById('articleForm').addEventListener('submit', async e => {
        e.preventDefault();
        const data = {
            id: document.getElementById('artId').value || null,
            title: document.getElementById('artTitle').value,
            articleType: document.getElementById('artType').value,
            isTop: document.getElementById('artTop').value,
            content: document.getElementById('artContent').value,
            coverImage: document.getElementById('artBase64').value
        };

        const url = data.id ? 'http://localhost:8080/api/article/update' : 'http://localhost:8080/api/article/add';
        const method = data.id ? 'PUT' : 'POST';

        try {
            const res = await fetch(url, { method: method, headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) });
            const result = await res.json();
            if(result.code === 200) {
                alert('âœ… å‘å¸ƒæˆåŠŸï¼');
                closeModal('articleModal');
                loadNews();
                document.getElementById('articleForm').reset();
                document.getElementById('artBase64').value = '';
                document.getElementById('artPreview').style.display = 'none';
            } else { alert('âŒ å¤±è´¥: ' + result.msg); }
        } catch (err) { alert('âŒ ç½‘ç»œé”™è¯¯'); }
    });

    async function delArticle(id) { if(confirm('ç¡®å®šåˆ é™¤å—?')) { await fetch(`http://localhost:8080/api/article/${id}`, {method:'DELETE'}); loadNews(); } }

    function toggleMallView(v) { document.getElementById('mall-products').style.display = v==='product'?'block':'none'; document.getElementById('mall-orders').style.display = v==='order'?'block':'none'; }
    async function loadProducts() { const d = await (await fetch('http://localhost:8080/api/product/list')).json(); document.getElementById('tbody-product').innerHTML = d.data.records.map(p => `<tr><td><img src="${p.image}" style="width:30px;"></td><td>${p.name}</td><td>${p.price}</td><td>${p.stock}</td><td>${p.status===1?'ä¸Šæ¶':'ä¸‹æ¶'}</td><td><button onclick="delProd(${p.id})">åˆ </button></td></tr>`).join(''); }
    async function loadOrders() { const d = await (await fetch('http://localhost:8080/api/exchange/list')).json(); document.getElementById('tbody-order').innerHTML = d.data.records.map(o => `<tr><td>${o.orderNo}</td><td>${o.productName}</td><td>UID:${o.volunteerId}</td><td>${o.receiveStatus===1?'å·²å‘':'å¾…å‘'}</td><td>${o.receiveStatus===0?`<button onclick="ship(${o.id})">å‘è´§</button>`:'-'}</td></tr>`).join(''); }
    async function ship(id) { await fetch(`http://localhost:8080/api/exchange/ship/${id}`, {method:'PUT'}); loadOrders(); }
    function openProductModal() { document.getElementById('productModal').classList.add('active'); }
    function handleProdImg(i) { if(i.files[0]) { const r=new FileReader(); r.onload=e=>{document.getElementById('prodBase64').value=e.target.result; document.getElementById('prodPreview').src=e.target.result; document.getElementById('prodPreview').style.display='block'}; r.readAsDataURL(i.files[0]); } }
    document.getElementById('productForm').addEventListener('submit', async e => { e.preventDefault(); const d={name:document.getElementById('prodName').value, price:document.getElementById('prodPrice').value, stock:document.getElementById('prodStock').value, image:document.getElementById('prodBase64').value}; await fetch('http://localhost:8080/api/product/add', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)}); closeModal('productModal'); loadProducts(); });

    function logout() { localStorage.removeItem('userInfo'); location.href='login.html'; }
</script>
</body>
</html>